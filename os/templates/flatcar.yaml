{{- $cmd := include "os.cmd" . -}}
{{- if eq $cmd "flatcar-yaml" -}}
{{- $target := required "target missing" .Values.target -}}
{{- $position := required "position missing" .Values.position -}}
{{- $env := include "os.env" . -}}
{{- $e := index .Values.env $env -}}
{{- $k3s_cmd := include "os.k3s_cmd" (dict "position" $position) -}}
{{- $kube_vip := get $e "kube_vip" | default dict -}}
variant: flatcar
version: 1.0.0

{{- if or (eq $e.k3s "single") (eq $e.k3s "etcd") }}
systemd:
  units:
    {{- include "os.systemd.units.k3s.install.service" (dict "k3s_cmd" $k3s_cmd) | nindent 4 }}
{{- end }}

storage:
  links:
    {{- include "os.storage.links.containerd.flatcar.raw" . | nindent 4 }}
  files:
    {{- include "os.storage.files.etc.flatcar.update.conf" . | nindent 4 }}
    {{- if eq $e.k3s "etcd" }}
      {{- include "os.storage.files.opt.bin.e" . | nindent 4 }}
      {{- include "os.storage.files.etc.rancher.k3s.config.yaml" (dict "e" $e "target" $target "position" $position) | nindent 4 }}
      {{- if and (eq $k3s_cmd "server") ($kube_vip) }}
        {{- include "os.storage.files.kube.vip.rbac.yaml" . | nindent 4 }}
        {{- include "os.storage.files.kube.vip.daemonset.yaml" $kube_vip | nindent 4 }}
        {{- include "os.storage.files.prometheus.yaml" (dict "e" $e "namespace" "mon") | nindent 4 }}
      {{- end }}
    {{- end }}

passwd:
  users:
  {{- include "os.passwd.users.core" (dict "ssh_authorized_keys" $e.ssh_authorized_keys) | nindent 2 }}
{{- end }}
