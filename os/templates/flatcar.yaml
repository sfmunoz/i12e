{{- $cmd := include "os.cmd" . -}}
{{- $target := .Values.target -}}
{{- $position := .Values.position -}}
{{- $k3s_url := .Values.k3s_url -}}
{{- if and (eq $cmd "flatcar-yaml") ($target) ($position) ($k3s_url) -}}
{{- $env := include "os.env" . -}}
{{- $k3s_cmd := le $position 3 | ternary "server" "agent" -}}
{{- $e := index .Values.env $env -}}
{{- $vip := $e | dig "kube_vip" "vip" "" -}}
{{- $interface := $e | dig "kube_vip" "interface" "" -}}
{{- $kvversion := $e | dig "kube_vip" "kvversion" "" -}}
variant: flatcar
version: 1.0.0

{{- if or (eq $e.k3s "single") (eq $e.k3s "etcd") }}
systemd:
  units:
    {{- include "os.systemd.units.k3s.install.service" (dict "k3s_cmd" $k3s_cmd) | nindent 4 }}
{{- end }}

storage:
  links:
    {{- include "os.storage.links.containerd.flatcar.raw" . | nindent 4 }}
  files:
    {{- include "os.storage.files.etc.flatcar.update.conf" . | nindent 4 }}
    {{- if eq $e.k3s "etcd" }}
      {{- include "os.storage.files.opt.bin.e" . | nindent 4 }}
      {{- include "os.storage.files.etc.rancher.k3s.config.yaml" (dict "k3s_cmd" $k3s_cmd "k3s_token" $e.k3s_token "k3s_agent_token" $e.k3s_agent_token "k3s_url" $k3s_url "vip" $vip "position" $position "target" $target ) | nindent 4 }}
      {{- if and (eq $k3s_cmd "server") ($vip) ($interface) ($kvversion) }}
        {{- include "os.storage.files.kube.vip.rbac.yaml" . | nindent 4 }}
        {{- include "os.storage.files.kube.vip.daemonset.yaml" (dict "vip" $vip "interface" $interface "kvversion" $kvversion) | nindent 4 }}
      {{- end }}
    {{- end }}

passwd:
  users:
  {{- include "os.passwd.users.core" (dict "ssh_authorized_keys" $e.ssh_authorized_keys) | nindent 2 }}
{{- end }}
