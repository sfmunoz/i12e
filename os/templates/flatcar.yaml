{{- $cmd := include "os.cmd" . -}}
{{- $target := .Values.target -}}
{{- if and (eq $cmd "flatcar-yaml") ($target) -}}
{{- $env := include "os.env" . -}}
{{- $e := index .Values.env $env -}}
variant: flatcar
version: 1.0.0

systemd:
{{- if or (eq $e.k3s "standalone") (eq $e.k3s "etcd") }}
  units:
    - name: k3s-install.service
      enabled: true
      contents: |
        [Unit]
        Description=K3s install
        Wants=network-online.target
        After=network-online.target
        ConditionFirstBoot=yes
        [Service]
        Type=oneshot
        Restart=on-failure
        RemainAfterExit=true
        ExecStart=/usr/bin/bash -c 'set -e -o pipefail ; curl -sfL https://get.k3s.io | sh -'
        [Install]
        WantedBy=multi-user.target
{{- end }}

storage:
  files:
    - path: /etc/flatcar/update.conf
      overwrite: true
      contents:
        inline: |
          REBOOT_STRATEGY=reboot
          REBOOT_WINDOW_START=01:30
          REBOOT_WINDOW_LENGTH=1h
      mode: 0644
{{- if eq $e.k3s "etcd" }}
    # https://docs.k3s.io/installation/configuration
    - path: /etc/rancher/k3s/config.yaml
      overwrite: true
      contents:
        inline: |
          token: {{ required "k3s_token missing" $e.k3s_token | quote }}
          node-ip: {{ $target | quote }}
          cluster-init: true
      mode: 0600
{{- end }}

passwd:
  users:
  - name: core
{{- with $e.ssh_authorized_keys }}
    ssh_authorized_keys:
{{- range . }}
    - "{{ . }}"
{{- end }}
{{- end }}
{{- end }}
