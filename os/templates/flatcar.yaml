{{- $cmd := include "os.cmd" . -}}
{{- $target := .Values.target -}}
{{- $position := .Values.position -}}
{{- $k3s_url := .Values.k3s_url -}}
{{- if and (eq $cmd "flatcar-yaml") ($target) ($position) ($k3s_url) -}}
{{- $env := include "os.env" . -}}
{{- $k3s_cmd := le $position 3 | ternary "server" "agent" -}}
{{- $e := index .Values.env $env -}}
{{- $vip := $e | dig "kube_vip" "vip" "" -}}
{{- $interface := $e | dig "kube_vip" "interface" "" -}}
{{- $kvversion := $e | dig "kube_vip" "kvversion" "" -}}
variant: flatcar
version: 1.0.0

systemd:
{{- if or (eq $e.k3s "single") (eq $e.k3s "etcd") }}
  units:
    {{- include "os.systemd.units.k3s.install.service" (dict "k3s_cmd" $k3s_cmd) | nindent 4 }}
{{- end }}

storage:
  links:
    # https://www.flatcar.org/docs/latest/provisioning/sysext/
    - path: /etc/extensions/containerd-flatcar.raw
      target: /dev/null
      overwrite: true
  files:
    - path: /etc/flatcar/update.conf
      overwrite: true
      contents:
        inline: |
          REBOOT_STRATEGY=reboot
          REBOOT_WINDOW_START=01:30
          REBOOT_WINDOW_LENGTH=1h
      mode: 0644
{{- if eq $e.k3s "etcd" }}
    - path: /opt/bin/e
      overwrite: true
      contents:
        inline: |
          #!/bin/bash
          # e get / --prefix -w json | jq .
          D="/var/lib/rancher/k3s/server/tls/etcd"
          exec etcdctl --key=${D}/client.key --cert=${D}/client.crt --cacert=${D}/server-ca.crt "$@"
      mode: 0755
    # https://docs.k3s.io/installation/configuration
    - path: /etc/rancher/k3s/config.yaml
      overwrite: true
      contents:
        inline: |
{{- if eq $k3s_cmd "server" }}
          token: {{ required "k3s_token missing" $e.k3s_token | quote }}
          agent-token: {{ required "k3s_agent_token missing" $e.k3s_agent_token | quote }}
          secrets-encryption: true
          secrets-encryption-provider: secretbox
{{- if $vip }}
          tls-san: {{ $vip | quote }}
{{- end }}
{{- else }}
          token: {{ required "k3s_agent_token missing" $e.k3s_agent_token | quote }}
{{- end }}
{{- if eq $position 1 }}
          cluster-init: true
{{- else }}
          server: {{ $k3s_url | quote }}
{{- end }}
          node-ip: {{ $target | quote }}
      mode: 0600
{{- if and (eq $k3s_cmd "server") ($vip) ($interface) ($kvversion) }}
    - path: /var/lib/rancher/k3s/server/manifests/kube-vip-rbac.yaml
      overwrite: true
      mode: 0600
      contents:
        inline: |
          {{- include "os.kube.vip.rbac" . | nindent 10 }}
    - path: /var/lib/rancher/k3s/server/manifests/kube-vip-daemonset.yaml
      overwrite: true
      mode: 0600
      contents:
        inline: |
          {{- include "os.kube.vip.daemonset" (dict "vip" $vip "interface" $interface "kvversion" $kvversion) | nindent 10 }}
{{- end }}
{{- end }}

passwd:
  users:
  - name: core
{{- with $e.ssh_authorized_keys }}
    ssh_authorized_keys:
{{- range . }}
    - "{{ . }}"
{{- end }}
{{- end }}
{{- end }}
