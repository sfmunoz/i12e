{{- $cmd := include "os.cmd" . -}}
{{- $target := .Values.target -}}
{{- $position := .Values.position -}}
{{- $k3s_url := .Values.k3s_url -}}
{{- if and (eq $cmd "flatcar-yaml") ($target) ($position) ($k3s_url) -}}
{{- $env := include "os.env" . -}}
{{- $k3s_cmd := le $position 3 | ternary "server" "agent" -}}
{{- $e := index .Values.env $env -}}
variant: flatcar
version: 1.0.0

systemd:
{{- if or (eq $e.k3s "single") (eq $e.k3s "etcd") }}
  units:
    - name: k3s-install.service
      enabled: true
      contents: |
        [Unit]
        Description=K3s install
        Wants=network-online.target
        After=network-online.target
        ConditionFirstBoot=yes
        [Service]
        Type=oneshot
        Restart=on-failure
        RemainAfterExit=true
        ExecStart=/usr/bin/bash -c 'set -e -o pipefail ; curl -sfL https://get.k3s.io | sh -s - {{ $k3s_cmd }}'
        [Install]
        WantedBy=multi-user.target
{{- end }}

storage:
  files:
    - path: /etc/flatcar/update.conf
      overwrite: true
      contents:
        inline: |
          REBOOT_STRATEGY=reboot
          REBOOT_WINDOW_START=01:30
          REBOOT_WINDOW_LENGTH=1h
      mode: 0644
{{- if eq $e.k3s "etcd" }}
    - path: /opt/bin/e
      overwrite: true
      contents:
        inline: |
          #!/bin/bash
          # e get / --prefix -w json | jq .
          D="/var/lib/rancher/k3s/server/tls/etcd"
          exec etcdctl --key=${D}/client.key --cert=${D}/client.crt --cacert=${D}/server-ca.crt "$@"
      mode: 0755
    # https://docs.k3s.io/installation/configuration
    - path: /etc/rancher/k3s/config.yaml
      overwrite: true
      contents:
        inline: |
{{- if eq $k3s_cmd "server" }}
          token: {{ required "k3s_token missing" $e.k3s_token | quote }}
          agent-token: {{ required "k3s_agent_token missing" $e.k3s_agent_token | quote }}
{{- else }}
          token: {{ required "k3s_agent_token missing" $e.k3s_agent_token | quote }}
{{- end }}
{{- if eq $position 1 }}
          cluster-init: true
{{- else }}
          server: {{ $k3s_url | quote }}
{{- end }}
          node-ip: {{ $target | quote }}
      mode: 0600
{{- end }}

passwd:
  users:
  - name: core
{{- with $e.ssh_authorized_keys }}
    ssh_authorized_keys:
{{- range . }}
    - "{{ . }}"
{{- end }}
{{- end }}
{{- end }}
